<!doctype html>
<meta charset="utf-8">
<title>Realtime Subtitles</title>
<style>
body{font-family:system-ui,Segoe UI,Arial;max-width:760px;margin:24px auto;padding:0 16px}
#log{white-space:pre-wrap;border:1px solid #ddd;padding:12px;min-height:160px}
button{padding:10px 14px;margin-right:8px}
</style>
<h1>Realtime Subtitles</h1>
<div>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <span id="status"></span>
  <div id="subs" style="border:1px solid #ddd;padding:12px;min-height:120px;margin-top:12px"></div>
  <div id="log"></div>
</div>
<script>
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const subsEl = document.getElementById('subs');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
let ws=null, mediaRecorder=null;

function log(t){ logEl.textContent += (t+'\n'); logEl.scrollTop = logEl.scrollHeight }
function setStatus(t){ statusEl.textContent = t }
function appendText(t){ if(!t) return; const p=document.createElement('span'); p.textContent=t; subsEl.appendChild(p); subsEl.appendChild(document.createTextNode(' ')); subsEl.scrollTop=subsEl.scrollHeight }
function extractText(d){ try{ const o=JSON.parse(d); const x=(o&&o.transcription&&o.transcription.text)||o.text||''; return (typeof x==='string')?x:'' }catch(_){ return '' } }
function onMessage(ev){ try{ const outer=JSON.parse(ev.data); if(outer&&outer.data){ const t=extractText(outer.data); if(t&&t.trim()) appendText(t.trim()) } }catch(_){ }
}

async function start(){
  try{
    ws = new WebSocket(`ws://${location.host}/ws`);
    ws.onopen = ()=> setStatus('Connected');
    ws.onmessage = onMessage;
    ws.onclose = ()=> setStatus('Disconnected');
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const ac = new AudioContext({ sampleRate: 16000 });
    const src = ac.createMediaStreamSource(stream);
    const proc = ac.createScriptProcessor(4096, 1, 1);
    src.connect(proc); proc.connect(ac.destination);
    proc.onaudioprocess = (e)=>{
      if(!ws || ws.readyState !== 1) return;
      const input = e.inputBuffer.getChannelData(0);
      const pcm16 = new Int16Array(input.length);
      for(let i=0;i<input.length;i++){ let s = Math.max(-1, Math.min(1, input[i])); pcm16[i] = s<0 ? s*0x8000 : s*0x7FFF }
      ws.send(new Blob([pcm16.buffer], { type: 'application/octet-stream' }));
    };
    startBtn.disabled = true; stopBtn.disabled = false;
  }catch(e){ setStatus('Mic denied'); }
}

function stop(){ try{ ws && ws.close(); }catch(_){ } startBtn.disabled=false; stopBtn.disabled=true; }

startBtn.onclick = start; stopBtn.onclick = stop;
</script>

