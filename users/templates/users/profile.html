{% extends 'users/base.html' %}

{% block title %}My Profile - {{ user.username }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12 col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-user me-2"></i>{{ user.username }}'s Vocabulary
                    </h4>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-book me-1"></i>{{ total_words }} words
                    </span>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="mb-3 d-flex align-items-center justify-content-between">
                    <div>
                        <span id="sub-status" class="badge bg-secondary">Checking subscription…</span>
                    </div>
                    <button id="start-trial" class="btn btn-success">
                        <i class="fas fa-crown me-2"></i>Start 7-day free trial
                    </button>
                </div>
                {% if vocabularies %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" data-sort="korean_word">
                                        <a class="text-reset text-decoration-none" href="?sort=korean_word&dir={% if sort == 'korean_word' %}{% if dir == 'asc' %}desc{% else %}asc{% endif %}{% else %}asc{% endif %}">
                                            <i class="fas fa-language me-1"></i>Korean Word
                                            {% if sort == 'korean_word' %}<span class="ms-1">{% if dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}</span>{% endif %}
                                        </a>
                                    </th>
                                    <th scope="col" data-sort="english">
                                        <a class="text-reset text-decoration-none" href="?sort=english&dir={% if sort == 'english' %}{% if dir == 'asc' %}desc{% else %}asc{% endif %}{% else %}asc{% endif %}">
                                            <i class="fas fa-translate me-1"></i>English Translation
                                            {% if sort == 'english' %}<span class="ms-1">{% if dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}</span>{% endif %}
                                        </a>
                                    </th>
                                    <th scope="col" style="width:220px" data-sort="retention">
                                        <a class="text-reset text-decoration-none" href="?sort=retention&dir={% if sort == 'retention' %}{% if dir == 'asc' %}desc{% else %}asc{% endif %}{% else %}asc{% endif %}">
                                            <i class="fas fa-heartbeat me-1"></i>Retention
                                            {% if sort == 'retention' %}<span class="ms-1">{% if dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}</span>{% endif %}
                                        </a>
                                    </th>
                                    <th scope="col" data-sort="added">
                                        <a class="text-reset text-decoration-none" href="?sort=added&dir={% if sort == 'added' %}{% if dir == 'asc' %}desc{% else %}asc{% endif %}{% else %}asc{% endif %}">
                                            <i class="fas fa-calendar me-1"></i>Added
                                            {% if sort == 'added' %}<span class="ms-1">{% if dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}</span>{% endif %}
                                        </a>
                                    </th>
                                    <th scope="col" data-sort="reviewed">
                                        <a class="text-reset text-decoration-none" href="?sort=reviewed&dir={% if sort == 'reviewed' %}{% if dir == 'asc' %}desc{% else %}asc{% endif %}{% else %}desc{% endif %}">
                                            <i class="fas fa-clock me-1"></i>Last Reviewed
                                            {% if sort == 'reviewed' %}<span class="ms-1">{% if dir == 'asc' %}&uarr;{% else %}&darr;{% endif %}</span>{% endif %}
                                        </a>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vocab in vocabularies %}
                                <tr>
                                    <td>
                                        <span class="fw-bold text-primary">{{ vocab.korean_word }}</span>
                                    </td>
                                    
                                    <td>{{ vocab.english_translation }}</td>
                                    <td>
                                        <div class="progress" style="height: 10px;">
                                            {% with pct=vocab.health|default:0 %}
                                            <div class="progress-bar {% if pct >= 75 %}bg-success{% elif pct >= 40 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ pct|floatformat:0 }}%;" aria-valuenow="{{ pct|floatformat:0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            {% endwith %}
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ vocab.created_at|date:"M d, Y" }}
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ vocab.last_reviewed|date:"M d, Y" }}
                                        </small>
                                    </td>
                                    
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No vocabulary words yet</h5>
                        <p class="text-muted">Start analyzing Korean text and click on words to build your vocabulary!</p>
                        <a href="{% url 'home' %}" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Go to Analysis
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const statusEl = document.getElementById('sub-status')
  const btn = document.getElementById('start-trial')
  async function refresh() {
    try{
      const r = await fetch('/billing/status/')
      const d = await r.json()
      if (d.active) {
        statusEl.textContent = `Active: ${d.status}`
        statusEl.className = 'badge bg-success'
        btn.style.display = 'none'
      } else {
        statusEl.textContent = 'Inactive'
        statusEl.className = 'badge bg-danger'
        btn.style.display = ''
      }
    }catch(_){
      statusEl.textContent = 'Unknown'
      statusEl.className = 'badge bg-secondary'
    }
  }
  btn.addEventListener('click', async () => {
    btn.disabled = true
    btn.textContent = 'Redirecting to PayPal…'
    try{
      const r = await fetch('/billing/create-subscription/')
      const d = await r.json()
      if (d.approval_url) {
        window.location.href = d.approval_url
      } else {
        btn.disabled = false
        btn.textContent = 'Start 7-day free trial'
      }
    }catch(_){
      btn.disabled = false
      btn.textContent = 'Start 7-day free trial'
    }
  })
  refresh()
})
</script>
{% endblock %} 